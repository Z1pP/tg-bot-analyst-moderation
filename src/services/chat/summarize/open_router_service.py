import logging

from openrouter import OpenRouter

from constants.enums import SummaryType

from .ai_service_base import IAIService

logger = logging.getLogger(__name__)

SYSTEM_CONTENT = (
    "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥ —á–∞—Ç–∞ –∏ –≤—ã–¥–∞—Ç—å –≥–ª—É–±–æ–∫—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É. "
    "–í–ê–ñ–ù–û: –ù–µ –∏—Å–æ–ª—å–∑—É–π HTML-—Ä–∞–∑–º–µ—Ç–∫—É Telegram (<b>, <i>, <code>), –∞ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç."
    "–ü–†–ê–í–ò–õ–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø:\n"
    "- –ü—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π —Å–∏–º–≤–æ–ª '@' –ø–µ—Ä–µ–¥ –∏—Ö username (–Ω–∞–ø—Ä–∏–º–µ—Ä, @username).\n"
    "- –ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–µ–Ω: —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ –≤—ã–≤–æ–¥–æ–≤, –∞ –Ω–µ –Ω–∞ –æ–±—ä–µ–º–µ —Ç–µ–∫—Å—Ç–∞.\n"
    "- –í –∞–Ω–∞–ª–∏–∑–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—á–∏—Ç—ã–≤–∞–π —Å–ø–∏—Å–æ–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {tracked_users_list}."
    "- –ï—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –ª–æ–≥–µ —Å–æ–æ–±—â–µ–Ω–∏–π, —Ç–æ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –µ–≥–æ –≤ –∞–Ω–∞–ª–∏–∑–µ."
)
USER_CONTENT_SHORT = (
    "–ü—Ä–æ–≤–µ–¥–∏ —ç–∫—Å–ø—Ä–µ—Å—Å-–∞–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–∞. –í –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å –∑–∞–≥–æ–ª–æ–≤–æ–∫: "
    "'üìä –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–∂–∏–º–∫–∞ ({msg_count} —Å–æ–æ–±—â.)'\n\n"
    "–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏—Ö –ø—É–Ω–∫—Ç–∞—Ö:\n"
    "üå° –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞: [—Ç–µ–∑–∏—Å–Ω–æ –æ–± –æ–±—â–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ –≤ —á–∞—Ç–µ]\n"
    "üîç –°—É—Ç—å: [—Ç–æ–ø-1 —Ç–µ–º–∞ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è]\n"
    "ü§© –ö–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ: [–∫–ª—é—á–µ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤—Å–µ –æ–±—Å—É–∂–¥–∞–ª–∏]\n"
    "üßê –£—á–∞—Å—Ç–∏–µ –æ—Ç—Å–ª. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: [–æ–±—â–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {tracked_users_list}]\n\n"
    "–õ–æ–≥ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n{text}"
)

USER_CONTENT_FULL = (
    "–ü—Ä–æ–≤–µ–¥–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä –¥–∏–∞–ª–æ–≥–∞. –í –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å –∑–∞–≥–æ–ª–æ–≤–æ–∫: "
    "'üìà –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –æ–±—Å—É–∂–¥–µ–Ω–∏—è ({msg_count} —Å–æ–æ–±—â.)'\n\n"
    "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç—á–µ—Ç –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:\n"
    "üå° –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –∏ —Ç–æ–Ω: [–∞–Ω–∞–ª–∏–∑ –æ–±—â–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –≤ —á–∞—Ç–µ]\n"
    "üîç –°—É—Ç—å: [—Ç–æ–ø-5 —Ç–µ–º –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è]\n"
    "ü§© –ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è: [—Ç–æ–ø-3 —Å–æ–±—ã—Ç–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ –æ–±—Å—É–∂–¥–∞–ª–∏]\n"
    "ü§® –£—á–∞—Å—Ç–Ω–∏–∫–∏: [—Ç–æ–ø-5 —á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞]\n"
    "‚ùå –†–∏—Å–∫–∏ –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã: [—Ç–æ–ø-5 –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∏ —Ä–∏—Å–∫–∏ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏]\n"
    "üßê <b>–£—á–∞—Å—Ç–∏–µ –æ—Ç—Å–ª. –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</b> [–æ–±—â–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {tracked_users_list}]\n\n"
    "–ü–†–ê–í–ò–õ–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø:\n"
    "- –ò—Å–ø–æ–ª—å–∑—É–π –±—É–ª–ª–∏—Ç—ã (‚Ä¢) –¥–ª—è —Å–ø–∏—Å–∫–æ–≤.\n"
    "- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –±–æ–ª–µ–µ —á–µ–º –æ–¥–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è.\n"
    "–õ–æ–≥ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n{text}"
)


class OpenRouterService(IAIService):
    def __init__(self, api_key: str, model_name: str) -> None:
        super().__init__(model_name)
        self._api_key = api_key

    async def summarize_text(
        self,
        text: str,
        msg_count: int,
        summary_type: SummaryType,
        tracked_users: list[str],
    ) -> str:
        async with OpenRouter(api_key=self._api_key) as client:
            try:
                user_content = (
                    USER_CONTENT_SHORT
                    if summary_type == SummaryType.SHORT
                    else USER_CONTENT_FULL
                )
                tracked_users_str = (
                    ", ".join(tracked_users) if tracked_users else "–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"
                )
                response = await client.chat.send_async(
                    model=self._model_name,
                    messages=[
                        {
                            "role": "system",
                            "content": SYSTEM_CONTENT.format(
                                tracked_users_list=tracked_users_str
                            ),
                        },
                        {
                            "role": "user",
                            "content": user_content.format(
                                text=text,
                                msg_count=msg_count,
                                tracked_users_list=tracked_users_str,
                            ),
                        },
                    ],
                )

                return response.choices[0].message.content
            except Exception as e:
                logger.error("Unexpected AI error: %s", e, exc_info=True)
                return "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–≤–æ–¥–∫–∏."
