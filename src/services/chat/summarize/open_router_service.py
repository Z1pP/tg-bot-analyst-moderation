import logging

from openrouter import OpenRouter

from constants.enums import SummaryType

from .ai_service_base import IAIService

logger = logging.getLogger(__name__)

SYSTEM_CONTENT = (
    "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥ —á–∞—Ç–∞ –∏ –≤—ã–¥–∞—Ç—å –≥–ª—É–±–æ–∫—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É. "
    "–ò—Å–ø–æ–ª—å–∑—É–π HTML-—Ä–∞–∑–º–µ—Ç–∫—É Telegram (<b>, <i>, <code>) –∏ —ç–º–æ–¥–∑–∏. "
    "–í–ê–ñ–ù–û: –õ—é–±—ã–µ —Å–∏–º–≤–æ–ª—ã '<' –∏ '>', –Ω–µ —è–≤–ª—è—é—â–∏–µ—Å—è —á–∞—Å—Ç—å—é —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤, –∑–∞–º–µ–Ω—è–π –Ω–∞ &lt; –∏ &gt;. "
    "–ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–µ–Ω: —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ –≤—ã–≤–æ–¥–æ–≤, –∞ –Ω–µ –Ω–∞ –æ–±—ä–µ–º–µ —Ç–µ–∫—Å—Ç–∞."
)
USER_CONTENT_SHORT = (
    "–ü—Ä–æ–≤–µ–¥–∏ —ç–∫—Å–ø—Ä–µ—Å—Å-–∞–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–∞. –í –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å –∑–∞–≥–æ–ª–æ–≤–æ–∫: "
    "'<b>üìä –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–∂–∏–º–∫–∞ ({msg_count} —Å–æ–æ–±—â.)</b>'\n\n"
    "–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Ç—Ä–µ—Ö –ø—É–Ω–∫—Ç–∞—Ö:\n"
    "1. <b>üå° –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞:</b> –ö–∞–∫–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–µ–æ–±–ª–∞–¥–∞–ª–æ –≤ —á–∞—Ç–µ?\n"
    "2. <b>üîç –°—É—Ç—å:</b> –ö–∞–∫–∞—è –≥–ª–∞–≤–Ω–∞—è —Ç–µ–º–∞ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ–±—Å—É–∂–¥–∞–ª–∞—Å—å?\n"
    "3. <b>‚úÖ –ò—Ç–æ–≥:</b> –ö–∞–∫–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ?\n\n"
    "–õ–æ–≥ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n{text}"
)

USER_CONTENT_FULL = (
    "–ü—Ä–æ–≤–µ–¥–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä –¥–∏–∞–ª–æ–≥–∞. –í –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å –∑–∞–≥–æ–ª–æ–≤–æ–∫: "
    "'<b>üìà –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –æ–±—Å—É–∂–¥–µ–Ω–∏—è ({msg_count} —Å–æ–æ–±—â.)</b>'\n\n"
    "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç—á–µ—Ç –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:\n"
    "1. <b>üå° –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –∫–ª–∏–º–∞—Ç:</b> –ê–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–æ–Ω–∞ –∏ —É—Ä–æ–≤–Ω—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.\n"
    "2. <b>üîç –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã:</b> –ö—Ä–∞—Ç–∫–∏–π —Ä–∞–∑–±–æ—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –æ–±—Å—É–∂–¥–µ–Ω–∏—è.\n"
    "3. <b>‚úÖ –†–µ—à–µ–Ω–∏—è –∏ Action Items:</b> –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π, –ø—Ä–∏–Ω—è—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á.\n"
    "4. <b>üë§ –£—á–∞—Å—Ç–Ω–∏–∫–∏:</b> –ö—Ç–æ –±—ã–ª –Ω–∞–∏–±–æ–ª–µ–µ –∞–∫—Ç–∏–≤–µ–Ω –∏ –∫–∞–∫—É—é —Ä–æ–ª—å –∏–≥—Ä–∞–ª (–ª–∏–¥–µ—Ä, –∫—Ä–∏—Ç–∏–∫, –ø–æ–º–æ—â–Ω–∏–∫ –∏ —Ç.–¥.).\n"
    "5. <b>‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã:</b> –ü–æ–¥—Å–≤–µ—Ç–∏ —Å–ø–æ—Ä–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏–ª–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏.\n\n"
    "–ü–†–ê–í–ò–õ–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø:\n"
    "- –ò—Å–ø–æ–ª—å–∑—É–π –±—É–ª–ª–∏—Ç—ã (‚Ä¢) –¥–ª—è —Å–ø–∏—Å–∫–æ–≤.\n"
    "- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –±–æ–ª–µ–µ —á–µ–º –æ–¥–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è.\n"
    "- –ö–∞–∂–¥–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≤ –ø—É–Ω–∫—Ç–µ 'Action Items' –ø–∏—à–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ —ç–º–æ–¥–∑–∏ ‚úÖ.\n\n"
    "–õ–æ–≥ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n{text}"
)


class OpenRouterService(IAIService):
    def __init__(self, api_key: str, model_name: str) -> None:
        super().__init__(model_name)
        self._api_key = api_key

    async def summarize_text(
        self, text: str, msg_count: int, summary_type: SummaryType
    ) -> str:
        async with OpenRouter(api_key=self._api_key) as client:
            try:
                user_content = (
                    USER_CONTENT_SHORT
                    if summary_type == SummaryType.SHORT
                    else USER_CONTENT_FULL
                )
                response = await client.chat.send_async(
                    model=self._model_name,
                    messages=[
                        {"role": "system", "content": SYSTEM_CONTENT},
                        {
                            "role": "user",
                            "content": user_content.format(
                                text=text, msg_count=msg_count
                            ),
                        },
                    ],
                )

                return response.choices[0].message.content
            except Exception as e:
                logger.error("Unexpected AI error: %s", e, exc_info=True)
                return "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–≤–æ–¥–∫–∏."
